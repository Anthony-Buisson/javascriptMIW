<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Tp promesses - partie 2</title>
</head>
<body>
<div class="form">
    <input id="refAchat" type="text">
</div>
<div class="result">
    <div class="date_achat"></div>
    <div class="montant_achat"></div>
    <div class="ref_voiture"></div>
    <div class="nom_modele"></div>
    <div class="code_marque"></div>
    <div class="nom_marque"></div>
</div>
</body>
<script src="JS/bibliAjax2.js"></script>
<script>
    setHTML=(node,html)=>{return document.querySelector(node).innerHTML = html};

    document.querySelector('#refAchat').onkeyup = remplirChamps;
    document.querySelector('#refAchat').onblur = remplirChamps;

    async function remplirChamps(){
        if(event.type === 'keyup' && event.key !== 'Enter') return;
        else document.querySelectorAll('.result *').forEach(champ=> champ.innerHTML = '');

        try{
            const Achats = JSON.parse((await $get('JS/Achat.js',null)).responseText);
            const Voitures = JSON.parse((await $get('JS/Voiture.js',null)).responseText);
            const Marques = JSON.parse((await $get('JS/Marque.js',null)).responseText);

            let refEstValide = false;
            Achats.forEach(achat => {
                if(achat.ref_achat == document.querySelector('#refAchat').value){
                    refEstValide = true;
                    setHTML('.date_achat', achat.date_achat);
                    setHTML('.montant_achat',achat.montant_achat);
                    setHTML('.ref_voiture',achat.ref_voiture);
                }
            });
            if(!refEstValide) setHTML('.date_achat', 'Aucun rÃ©sultat');

            Voitures.forEach(voiture => {
                if(voiture.ref_voiture == document.querySelector('.ref_voiture').innerHTML){
                    setHTML('.nom_modele',voiture.nom_modele);
                    setHTML('.code_marque',voiture.code_marque);
                }
            });

            Marques.forEach(marque => {
                if(marque.code_marque == document.querySelector('.code_marque').innerHTML) setHTML('.nom_marque',marque.nom_marque);
            });

        }catch(e){ cl('Erreur : '+e) }
    }
</script>
</html>